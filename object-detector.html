/* ====== BUFFER UNTUK SMOOTHING ====== */
let lastBox = null;
let distHistory = [];

/* ====== Dominant Color (lebih akurat) ====== */
function getDominantColor(ctx, x, y, w, h) {
  const img = ctx.getImageData(x, y, w, h);
  let r = 0, g = 0, b = 0;
  let count = 0;

  for (let i = 0; i < img.data.length; i += 4) {
    r += img.data[i];
    g += img.data[i + 1];
    b += img.data[i + 2];
    count++;
  }

  r = Math.round(r / count);
  g = Math.round(g / count);
  b = Math.round(b / count);

  return { r, g, b };
}

/* ====== SMOOTHING BOUNDING BOX ====== */
function smoothBox(current) {
  if (!lastBox) return lastBox = current;

  const smooth = 0.6; // semakin besar semakin halus
  return lastBox = [
    lastBox[0] * smooth + current[0] * (1 - smooth),
    lastBox[1] * smooth + current[1] * (1 - smooth),
    lastBox[2] * smooth + current[2] * (1 - smooth),
    lastBox[3] * smooth + current[3] * (1 - smooth)
  ];
}

/* ====== SMOOTHING JARAK (10 FRAME) ====== */
function smoothDistance(d) {
  distHistory.push(d);
  if (distHistory.length > 10) distHistory.shift();
  return Math.round(distHistory.reduce((a,b)=>a+b,0) / distHistory.length);
}

/* ====== MAIN DETECTION LOOP (UPGRADED) ====== */
async function runDetectionLoop() {
  if (!model) return console.warn("Model belum siap");

  async function frame() {
    ctx.clearRect(0, 0, overlay.width, overlay.height);
    ctx.drawImage(video, 0, 0, overlay.width, overlay.height);

    const predictions = await model.detect(video);
    const thr = parseFloat(thresholdEl.value);

    // pilih prediksi terbaik
    let best = null;
    predictions.forEach(p => {
      if (p.score >= thr && (!best || p.score > best.score)) best = p;
    });

    // update FPS
    frames++;
    const now = performance.now();
    if (now - lastTs >= 1000) {
      infoFps.innerText = frames + " FPS";
      frames = 0;
      lastTs = now;
    }

    if (best) {
      let [x, y, w, h] = smoothBox(best.bbox);

      // ambil warna dominan area lebih besar (30 Ã— 30)
      const sx = Math.max(0, Math.floor(x + w/2 - 15));
      const sy = Math.max(0, Math.floor(y + h/2 - 15));
      const color = getDominantColor(ctx, sx, sy, 30, 30);
      const colorName = namaWarnaFromRGB(color.r, color.g, color.b);

      // estimasi jarak lebih stabil (pakai width + height)
      const distRaw = estimateDistanceCm((w + h) / 2, 20);
      const distSmooth = smoothDistance(distRaw);

      // tampilkan info
      infoClass.innerText = best.class;
      infoColor.innerText = `${colorName} (${color.r},${color.g},${color.b})`;
      infoDist.innerText = distSmooth + " cm (stabil)";

      // gambar box
      ctx.lineWidth = 3;
      ctx.strokeStyle = "rgba(0,210,255,0.95)";
      ctx.strokeRect(x, y, w, h);

      ctx.fillStyle = "rgba(0,210,255,0.95)";
      ctx.fillRect(x, y - 30, 180, 28);

      ctx.fillStyle = "#001";
      ctx.font = "17px Arial";
      ctx.fillText(`${best.class} ${(best.score*100).toFixed(0)}%`, x + 6, y - 10);
    } else {
      infoClass.innerText = '-';
      infoColor.innerText = '-';
      infoDist.innerText = '-';
    }

    rafId = requestAnimationFrame(frame);
  }

  frame();
}
