<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Deteksi Objek â€¢ Warna Nama â€¢ Estimasi Jarak (Stabil)</title>
<style>
/* --- VARS & GLOBAL --- */
Â  :root{ --accent:#00d1ff; --bg:#071019; --card:#0b1620; --muted:#98aab8; }
Â  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#021018);color:#e8f6ff;font-family:Inter, Arial, sans-serif;font-size:15px;}
Â  
/* --- LAYOUT --- */
Â  .wrap{max-width:1080px;margin:18px auto;padding:18px;display:grid;grid-template-columns:640px 1fr; gap:18px;align-items:start;}
Â  @media (max-width: 1080px) {
Â  Â  .wrap { grid-template-columns: 1fr; }
Â  Â  #viewport { width: 100%; height: auto; aspect-ratio: 640 / 480; }
Â  }

/* --- COMPONENTS --- */
Â  h1{margin:0 0 8px 0;color:var(--accent);text-shadow:0 6px 30px rgba(0,200,255,0.06);}
Â  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:15px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(0,0,0,0.6);}
Â  #viewport{position:relative;width:100%;height:480px;border-radius:10px;overflow:hidden;border:2px solid rgba(0,200,255,0.08);}
Â  video{width:100%;height:100%;object-fit:cover;display:block;}
Â  canvas{position:absolute;left:0;top:0;pointer-events:none;}
Â  
/* --- INFO PANEL --- */
Â  .info{padding:15px;}
Â  .label{font-weight:600;color:var(--muted);font-size:0.9em;}
Â  .muted{color:var(--muted);font-size:13px}
Â  
Â  .stat-value { font-size: 1.2em; font-weight: 700; color: #fff; display: block; margin-top: 2px; }
Â  .color-swatch { 
Â  Â  display: inline-block; width: 20px; height: 20px; 
Â  Â  border-radius: 4px; border: 2px solid var(--accent); 
Â  Â  margin-right: 8px; vertical-align: middle; 
Â  Â  background: #333;
Â  Â  transition: background-color 0.3s;
Â  }
Â  .stat-row { margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.04); }
Â  .stat-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
Â  .info-section { margin-top: 15px; }

/* --- BUTTONS --- */
Â  .btn-group { display: flex; gap: 8px; margin-top: 10px; }
Â  .btn{appearance:none;border:0;padding:10px 12px;border-radius:8px;background:var(--accent);color:#012;font-weight:700;cursor:pointer;flex-grow:1; transition: background 0.3s, opacity 0.3s;}
Â  .btn:hover:not(:disabled) { background: #33eaff; }
Â  .btn:disabled { opacity: 0.5; cursor: not-allowed; background: var(--muted); color: var(--bg); }
Â  #btnSnapshot { background: #ff9900; } 
Â  #btnSnapshot:hover:not(:disabled) { background: #ffbb4d; }

Â  .small{font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
Â  <div>
Â  Â  <h1>Deteksi Objek â€¢ Warna Nama â€¢ Estimasi Jarak (Stabil)</h1>
Â  Â  <div class="card" id="viewerCard">
Â  Â  Â  <div id="viewport">
Â  Â  Â  Â  <video id="video" autoplay playsinline muted></video>
Â  Â  Â  Â  <canvas id="overlay"></canvas>
Â  Â  Â  </div>

Â  Â  Â  <div class="btn-group">
Â  Â  Â  Â  <button id="btnStart" class="btn">â–¶ï¸ Mulai Kamera</button>
Â  Â  Â  Â  <button id="btnStop" class="btn" disabled>â¹ Hentikan</button>
Â  Â  Â  Â  <button id="btnSnapshot" class="btn">ğŸ“¸ Snapshot</button>
Â  Â  Â  </div>

Â  Â  Â  <div style="margin-top:10px" class="muted">Pastikan izinkan kamera ketika browser meminta.</div>
Â  Â  </div>
Â  </div>

Â  <aside>
Â  Â  <div class="card info">
Â  Â  Â  <div class="stat-row"><span class="label">Status Model:</span> <span id="modelStatus" class="small">Belum dimuat</span></div>
Â  Â  Â  <div class="stat-row"><span class="label">FPS:</span> <span id="infoFps" class="small">-</span></div>

Â  Â  Â  <hr style="margin:10px 0;border:none;border-top:1px solid rgba(255,255,255,0.08)">

Â  Â  Â  <div class="info-section">
Â  Â  Â  Â  <div class="stat-row"><span class="label">Objek Utama:</span> <span id="infoClass" class="stat-value">-</span></div>
Â  Â  Â  Â  <div class="stat-row">
Â  Â  Â  Â  Â  <span class="label">Warna Rata-Rata:</span> 
Â  Â  Â  Â  Â  <span id="infoColorWrap" class="stat-value">
Â  Â  Â  Â  Â  Â  <span id="infoColorSwatch" class="color-swatch"></span>
Â  Â  Â  Â  Â  Â  <span id="infoColor">-</span>
Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="stat-row"><span class="label">Estimasi Jarak:</span> <span id="infoDist" class="stat-value">-</span></div>
Â  Â  Â  </div>

Â  Â  Â  <hr style="margin:10px 0;border:none;border-top:1px solid rgba(255,255,255,0.08)">

Â  Â  Â  <div class="small" style="margin-bottom:8px">Pengaturan Threshold Deteksi</div>
Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center;">
Â  Â  Â  Â  <label class="small">Keyakinan Minimum: <span id="thVal">0.45</span></label>
Â  Â  Â  </div>
Â  Â  Â  <input id="threshold" type="range" min="0.1" max="0.9" step="0.01" value="0.45" style="width:100%; margin-top:5px;"/>

Â  Â  Â  <div style="margin-top:15px" class="small">
Â  Â  Â  Â  Debug: Cek Console (F12) jika ada masalah.
Â  Â  Â  </div>
Â  Â  </div>
Â  </aside>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>

<script>
/* ====== Utility: map RGB -> nama warna sederhana ====== */
const NAMAWARNA = [
Â  {name:'Merah', r:220,g:40,b:40},
Â  {name:'Oren', r:255,g:140,b:50},
Â  {name:'Kuning', r:240,g:220,b:60},
Â  {name:'Hijau', r:50,g:200,b:80},
Â  {name:'Biru', r:40,g:120,b:255},
Â  {name:'Ungu', r:150,g:80,b:200},
Â  {name:'Coklat', r:140,g:90,b:60},
Â  {name:'Hitam', r:20,g:20,b:20},
Â  {name:'Abu-abu', r:140,g:140,b:140},
Â  {name:'Putih', r:240,g:240,b:240},
Â  {name:'Pink', r:255,g:120,b:180}
];

function namaWarnaFromRGB(r,g,b){
Â  let best=null, bestD=1e9;
Â  NAMAWARNA.forEach(c=>{
Â  Â  const d = (r-c.r)**2 + (g-c.g)**2 + (b-c.b)**2; 
Â  Â  if(d < bestD){ bestD=d; best=c; }
Â  });
Â  return best ? best.name : 'Tidak dikenal';
}

/* ====== Elemen UI ====== */
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');

const btnStart = document.getElementById('btnStart');
const btnStopÂ  = document.getElementById('btnStop');
const btnSnapshot = document.getElementById('btnSnapshot');

const modelStatus = document.getElementById('modelStatus');
const infoClass = document.getElementById('infoClass');
const infoColor = document.getElementById('infoColor');
const infoColorSwatch = document.getElementById('infoColorSwatch'); // Tambah Swatch
const infoDistÂ  = document.getElementById('infoDist');
const infoFpsÂ  Â = document.getElementById('infoFps');

const thresholdEl = document.getElementById('threshold');
const thVal = document.getElementById('thVal');

let model = null;
let stream = null;
let rafId = null;
let lastTs = performance.now();
let frames = 0;

/* ====== Variabel untuk Smoothing ====== */ 
let lastBox = null; 
let distHistory = []; 

/* ====== FUNGSI BARU UNTUK STABILITAS DAN AKURASI ====== */

/**
 * Mengambil warna rata-rata dari area yang lebih besar (Dominant Color).
 * @param {CanvasRenderingContext2D} ctx - Konteks Canvas.
 * @param {number} x - Koordinat X.
 * @param {number} y - Koordinat Y.
 * @param {number} w - Lebar area.
 * @param {number} h - Tinggi area.
 * @returns {{r: number, g: number, b: number}} Objek RGB rata-rata.
 */
function getDominantColor(ctx, x, y, w, h) {
Â  try {
Â  Â  // Pastikan koordinat tidak negatif
Â  Â  x = Math.max(0, x);
Â  Â  y = Math.max(0, y);
Â  Â  // Pastikan lebar/tinggi tidak melebihi batas canvas
Â  Â  w = Math.min(w, overlay.width - x);
Â  Â  h = Math.min(h, overlay.height - y);

Â  Â  if (w <= 0 || h <= 0) return { r: 0, g: 0, b: 0 };
Â  Â  
Â  Â  const img = ctx.getImageData(x, y, w, h);
Â  Â  let r = 0, g = 0, b = 0;
Â  Â  let count = 0;
Â  Â  for (let i = 0; i < img.data.length; i += 4) {
Â  Â  Â  r += img.data[i];
Â  Â  Â  g += img.data[i + 1];
Â  Â  Â  b += img.data[i + 2];
Â  Â  Â  count++;
Â  Â  }
Â  Â  r = Math.round(r / count);
Â  Â  g = Math.round(g / count);
Â  Â  b = Math.round(b / count);
Â  Â  return { r, g, b };
Â  } catch (e) {
Â  Â  console.warn('Gagal ambil warna:', e);
Â  Â  return { r: 0, g: 0, b: 0 };
Â  }
}

/**
 * Menerapkan smoothing (Exponential Moving Average) pada bounding box.
 * @param {number[]} current - BBox saat ini [x, y, w, h].
 * @returns {number[]} BBox yang telah di-smooth.
 */
function smoothBox(current) {
Â  if (!lastBox) return lastBox = current;
Â  const smooth = 0.7; // Semakin besar semakin halus, tapi semakin lambat merespon perubahan
Â  return lastBox = [
Â  Â  lastBox[0] * smooth + current[0] * (1 - smooth),
Â  Â  lastBox[1] * smooth + current[1] * (1 - smooth),
Â  Â  lastBox[2] * smooth + current[2] * (1 - smooth),
Â  Â  lastBox[3] * smooth + current[3] * (1 - smooth)
Â  ];
}

/**
 * Menerapkan smoothing (Moving Average) pada estimasi jarak (10 frame).
 * @param {number} d - Jarak saat ini (cm).
 * @returns {number} Jarak rata-rata yang telah di-smooth.
 */
function smoothDistance(d
