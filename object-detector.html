<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Deteksi Objek â€¢ Warna Nama â€¢ Estimasi Jarak (FIXED)</title>
<style>
/* --- VARS & GLOBAL --- */
Â  :root{ --accent:#00d1ff; --bg:#071019; --card:#0b1620; --muted:#98aab8; }
Â  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#021018);color:#e8f6ff;font-family:Inter, Arial, sans-serif;font-size:15px;}
Â  
/* --- LAYOUT --- */
Â  .wrap{max-width:1080px;margin:18px auto;padding:18px;display:grid;grid-template-columns:640px 1fr; gap:18px;align-items:start;}
Â  @media (max-width: 1080px) {
Â  Â  .wrap { grid-template-columns: 1fr; }
Â  Â  #viewport { width: 100%; height: auto; aspect-ratio: 640 / 480; }
Â  }

/* --- COMPONENTS --- */
Â  h1{margin:0 0 8px 0;color:var(--accent);text-shadow:0 6px 30px rgba(0,200,255,0.06);}
Â  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:15px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(0,0,0,0.6);}
Â  #viewport{position:relative;width:100%;height:480px;border-radius:10px;overflow:hidden;border:2px solid rgba(0,200,255,0.08);}
Â  video{width:100%;height:100%;object-fit:cover;display:block; /* NO MIRROR */ }
Â  canvas{position:absolute;left:0;top:0;pointer-events:none;}
Â  
/* --- INFO PANEL --- */
Â  .info{padding:15px;}
Â  .label{font-weight:600;color:var(--muted);font-size:0.9em;}
Â  .muted{color:var(--muted);font-size:13px}
Â  
Â  .stat-value { font-size: 1.2em; font-weight: 700; color: #fff; display: block; margin-top: 2px; }
Â  .color-swatch { 
Â  Â  display: inline-block; width: 20px; height: 20px; 
Â  Â  border-radius: 4px; border: 2px solid var(--accent); 
Â  Â  margin-right: 8px; vertical-align: middle; 
Â  Â  background: #333; /* default */
Â  Â  transition: background-color 0.3s;
Â  }
Â  .stat-row { margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.04); }
Â  .stat-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
Â  .info-section { margin-top: 15px; }

/* --- BUTTONS --- */
Â  .btn-group { display: flex; gap: 8px; margin-top: 10px; }
Â  .btn{appearance:none;border:0;padding:10px 12px;border-radius:8px;background:var(--accent);color:#012;font-weight:700;cursor:pointer;flex-grow:1; transition: background 0.3s, opacity 0.3s;}
Â  .btn:hover:not(:disabled) { background: #33eaff; }
Â  .btn:disabled { opacity: 0.5; cursor: not-allowed; background: var(--muted); color: var(--bg); }
Â  #btnSnapshot { background: #ff9900; } 
Â  #btnSnapshot:hover:not(:disabled) { background: #ffbb4d; }

Â  .small{font-size:13px;color:var(--muted)}
Â  pre{white-space:pre-wrap;margin:6px 0;color:#cfefff;background:rgba(0,0,0,0.08);padding:8px;border-radius:6px}
</style>
</head>
<body>
<div class="wrap">
Â  <div>
Â  Â  <h1>Deteksi Objek â€¢ Warna Nama â€¢ Estimasi Jarak</h1>
Â  Â  <div class="card" id="viewerCard">
Â  Â  Â  <div id="viewport">
Â  Â  Â  Â  <video id="video" autoplay playsinline muted></video>
Â  Â  Â  Â  <canvas id="overlay"></canvas>
Â  Â  Â  </div>

Â  Â  Â  <div class="btn-group">
Â  Â  Â  Â  <button id="btnStart" class="btn">â–¶ï¸ Mulai Kamera</button>
Â  Â  Â  Â  <button id="btnStop" class="btn" disabled>â¹ Hentikan</button>
Â  Â  Â  Â  <button id="btnSnapshot" class="btn">ğŸ“¸ Snapshot</button>
Â  Â  Â  </div>

Â  Â  Â  <div style="margin-top:10px" class="muted">Pastikan izinkan kamera ketika browser meminta.</div>
Â  Â  </div>
Â  </div>

Â  <aside>
Â  Â  <div class="card info">
Â  Â  Â  <div class="stat-row"><span class="label">Status Model:</span> <span id="modelStatus" class="small">Belum dimuat</span></div>
Â  Â  Â  <div class="stat-row"><span class="label">FPS:</span> <span id="infoFps" class="small">-</span></div>

Â  Â  Â  <hr style="margin:10px 0;border:none;border-top:1px solid rgba(255,255,255,0.08)">

Â  Â  Â  <div class="info-section">
Â  Â  Â  Â  <div class="stat-row"><span class="label">Objek Utama:</span> <span id="infoClass" class="stat-value">-</span></div>
Â  Â  Â  Â  <div class="stat-row">
Â  Â  Â  Â  Â  <span class="label">Warna Rata-Rata:</span> 
Â  Â  Â  Â  Â  <span id="infoColorWrap" class="stat-value">
Â  Â  Â  Â  Â  Â  <span id="infoColorSwatch" class="color-swatch"></span>
Â  Â  Â  Â  Â  Â  <span id="infoColor">-</span>
Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="stat-row"><span class="label">Estimasi Jarak:</span> <span id="infoDist" class="stat-value">-</span></div>
Â  Â  Â  </div>

Â  Â  Â  <hr style="margin:10px 0;border:none;border-top:1px solid rgba(255,255,255,0.08)">

Â  Â  Â  <div class="small" style="margin-bottom:8px">Pengaturan Threshold Deteksi</div>
Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center;">
Â  Â  Â  Â  <label class="small">Keyakinan Minimum: <span id="thVal">0.45</span></label>
Â  Â  Â  </div>
Â  Â  Â  <input id="threshold" type="range" min="0.1" max="0.9" step="0.01" value="0.45" style="width:100%; margin-top:5px;"/>

Â  Â  Â  <div style="margin-top:15px" class="small">
Â  Â  Â  Â  Debug: Lihat Console (F12) jika kamera belum muncul atau model gagal dimuat.
Â  Â  Â  </div>
Â  Â  </div>
Â  </aside>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>

<script>
/* ====== Utility: map RGB -> nama warna sederhana ====== */
const NAMAWARNA = [
Â  {name:'Merah', r:220,g:40,b:40},
Â  {name:'Oren', r:255,g:140,b:50},
Â  {name:'Kuning', r:240,g:220,b:60},
Â  {name:'Hijau', r:50,g:200,b:80},
Â  {name:'Biru', r:40,g:120,b:255},
Â  {name:'Ungu', r:150,g:80,b:200},
Â  {name:'Coklat', r:140,g:90,b:60},
Â  {name:'Hitam', r:20,g:20,b:20},
Â  {name:'Abu-abu', r:140,g:140,b:140},
Â  {name:'Putih', r:240,g:240,b:240},
Â  {name:'Pink', r:255,g:120,b:180}
];

function namaWarnaFromRGB(r,g,b){
Â  let best=null, bestD=1e9;
Â  NAMAWARNA.forEach(c=>{
Â  Â  // Jarak Euclidean kuadrat dalam ruang RGB
Â  Â  const d = (r-c.r)**2 + (g-c.g)**2 + (b-c.b)**2; 
Â  Â  if(d < bestD){ bestD=d; best=c; }
Â  });
Â  return best ? best.name : 'Tidak dikenal';
}

/* ====== Elements ====== */
const video = document.getElementById('video');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');

const btnStart = document.getElementById('btnStart');
const btnStopÂ  = document.getElementById('btnStop');
const btnSnapshot = document.getElementById('btnSnapshot');

const modelStatus = document.getElementById('modelStatus');
const infoClass = document.getElementById('infoClass');
const infoColor = document.getElementById('infoColor');
const infoColorSwatch = document.getElementById('infoColorSwatch');
const infoDistÂ  = document.getElementById('infoDist');
const infoFpsÂ  Â = document.getElementById('infoFps');

const thresholdEl = document.getElementById('threshold');
const thVal = document.getElementById('thVal');

let model = null;
let stream = null;
let rafId = null;
let lastTs = performance.now();
let frames = 0;

/* ====== Kamera ====== */
async function startCamera(){
Â  try{
Â  Â  btnStart.disabled = true;
Â  Â  const s = await navigator.mediaDevices.getUserMedia({
Â  Â  Â  video:{ width: {ideal:1280}, height:{ideal:720}, facingMode: 'environment' }, // Resolusi lebih besar
Â  Â  Â  audio:false
Â  Â  });
Â  Â  stream = s;
Â  Â  video.srcObject = stream;
Â  Â  await video.play();

Â  Â  // set canvas size to video size
Â  Â  overlay.width = video.videoWidth;
Â  Â  overlay.height = video.videoHeight;

Â  Â  // load model first time if not loaded
Â  Â  if(!model){
Â  Â  Â  await loadModel();
Â  Â  }

Â  Â  // start loop
Â  Â  runDetectionLoop();
Â  Â  btnStop.disabled = false;
Â  }catch(e){
Â  Â  console.error('Gagal akses kamera:', e);
Â  Â  alert('Gagal membuka kamera. Cek izin kamera di browser (allow) dan jalankan melalui HTTPS atau localhost.');
Â  Â  btnStart.disabled = false;
Â  }
}

function stopCamera(){
Â  if(stream){
Â  Â  stream.getTracks().forEach(t=>t.stop());
Â  Â  stream = null;
Â  }
Â  if(rafId) cancelAnimationFrame(rafId);
Â  btnStart.disabled = false;
Â  btnStop.disabled = true;
Â  // Reset info
Â  infoClass.innerText = '-';
Â  infoColor.innerText = '-';
Â  infoColorSwatch.style.backgroundColor = '#333';
Â  infoDist.innerText = '-';
Â  infoFps.innerText = '-';
Â  ctx.clearRect(0,0,overlay.width, overlay.height);
}

/* ====== Load model ====== */
async function loadModel(){
Â  try{
Â  Â  modelStatus.innerText = 'Memuat model...';
Â  Â  model = await cocoSsd.load();
Â  Â  modelStatus.innerText = 'Model siap âœ”';
Â  Â  console.log('Model coco-ssd siap.');
Â  }catch(e){
Â  Â  console.error('Gagal memuat model:', e);
Â  Â  modelStatus.innerText = 'Gagal memuat model (lihat console)';
Â  }
}

/* ====== Helper distance (simple estimation) ======
Â  Â Menggunakan focal-length-like formula:
Â  Â distance(cm) = (knownWidth_cm * focalLength) / pixelWidth
*/
function estimateDistanceCm(pixelWidth, knownWidthCm = 20){
Â  const focalLength = 800; // Nilai empiris untuk kamera web/smartphone
Â  if(pixelWidth <= 0) return 0;
Â  return Math.round((knownWidthCm * focalLength) / pixelWidth);
}

// Fungsi untuk mendapatkan lebar objek asumsi (dalam cm)
function getKnownWidthCm(className){
Â  switch(className){
Â  Â  case 'cell phone': return 8; // Ponsel 8 cm
Â  Â  case 'bottle': return 10;Â  // Botol 10 cm
Â  Â  case 'cup': return 8;Â  Â  Â  // Cangkir 8 cm
Â  Â  case 'person': return 40;Â  // Orang (lebar bahu) 40 cm
Â  Â  case 'book': return 15;Â  Â  // Buku 15 cm
Â  Â  default: return 20; // Default untuk objek lain
Â  }
}

/* ====== Main detection loop ====== */
async function runDetectionLoop(){
Â  if(!model || !stream) {
Â  Â  console.warn('Model atau stream kamera belum siap.');
Â  Â  return;
Â  }
Â  // draw loop
Â  async function frame(){
Â  Â  // Clear canvas dan draw video frame
Â  Â  ctx.clearRect(0,0,overlay.width, overlay.height);
Â  Â  ctx.drawImage(video, 0, 0, overlay.width, overlay.height);

Â  Â  try{
Â  Â  Â  const predictions = await model.detect(video);

Â  Â  Â  // update FPS
Â  Â  Â  frames++;
Â  Â  Â  const now = performance.now();
Â  Â  Â  if(now - lastTs >= 1000){
Â  Â  Â  Â  infoFps.innerText = frames + ' FPS';
Â  Â  Â  Â  frames = 0;
Â  Â  Â  Â  lastTs = now;
Â  Â  Â  }

Â  Â  Â  // draw boxes and info for each prediction above threshold
Â  Â  Â  const thr = parseFloat(thresholdEl.value);
Â  Â  Â  let primary = null; // Objek dengan skor tertinggi
Â  Â  Â  
Â  Â  Â  // Filter dan urutkan berdasarkan skor
Â  Â  Â  const filteredPredictions = predictions
Â  Â  Â  Â  .filter(pred => pred.score >= thr)
Â  Â  Â  Â  .sort((a,b) => b.score - a.score);
Â  Â  Â  
Â  Â  Â  if(filteredPredictions.length > 0) primary = filteredPredictions[0];

Â  Â  Â  filteredPredictions.forEach(pred=>{
Â  Â  Â  Â  // bounding box
Â  Â  Â  Â  const [x,y,w,h] = pred.bbox;

Â  Â  Â  Â  const isPrimary = pred === primary;
Â  Â  Â  Â  const label = pred.class + ' ' + (pred.score*100).toFixed(0) + '%';
Â  Â  Â  Â  
Â  Â  Â  Â  // Rectangle Style
Â  Â  Â  Â  ctx.lineWidth = isPrimary ? 4 : 2;
Â  Â  Â  Â  ctx.strokeStyle = isPrimary ? '#00FFFF' : 'rgba(0,210,255,0.7)'; 
Â  Â  Â  Â  ctx.shadowBlur = isPrimary ? 10 : 0; 
Â  Â  Â  Â  ctx.shadowColor = isPrimary ? 'rgba(0,255,255,0.8)' : 'rgba(0,210,255,0.4)';
Â  Â  Â  Â  ctx.strokeRect(x,y,w,h);

Â  Â  Â  Â  // Label background
Â  Â  Â  Â  ctx.shadowBlur = 0;
Â  Â  Â  Â  ctx.fillStyle = isPrimary ? '#00FFFF' : 'rgba(0,210,255,0.8)';
Â  Â  Â  Â  ctx.font = '700 16px Inter, Arial';
Â  Â  Â  Â  const tw = ctx.measureText(label).width + 10;
Â  Â  Â  Â  ctx.fillRect(x, y - 28, tw, 26);

Â  Â  Â  Â  // Label text
Â  Â  Â  Â  ctx.fillStyle = '#012'; 
Â  Â  Â  Â  ctx.fillText(label, x + 5, y - 8);
Â  Â  Â  Â  
Â  Â  Â  Â  // Tanda titik tengah untuk objek utama
Â  Â  Â  Â  if(isPrimary){
Â  Â  Â  Â  Â  ctx.fillStyle = 'red';
Â  Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  Â  ctx.arc(x + w/2, y + h/2, 4, 0, 2 * Math.PI);
Â  Â  Â  Â  Â  ctx.fill();
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  if(primary){
Â  Â  Â  Â  // --- 1. SAMPLE COLOR ---
Â  Â  Â  Â  // sample color at center of primary bbox (sample area 5x5)
Â  Â  Â  Â  const [x,y,w,h] = primary.bbox;
Â  Â  Â  Â  // Pastikan area sampel tidak keluar batas canvas
Â  Â  Â  Â  const sx = Math.max(0, Math.floor(x + w/2) - 2);
Â  Â  Â  Â  const sy = Math.max(0, Math.floor(y + h/2) - 2);
Â  Â  Â  Â  const sw = Math.min(5, overlay.width - sx);
Â  Â  Â  Â  const sh = Math.min(5, overlay.height - sy);

Â  Â  Â  Â  let rSum=0,gSum=0,bSum=0,count=0;
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  // Ambil data warna dari canvas (yang sudah digambar video di awal frame)
Â  Â  Â  Â  Â  const img = ctx.getImageData(sx, sy, sw, sh); 
Â  Â  Â  Â  Â  for(let i=0;i<img.data.length;i+=4){
Â  Â  Â  Â  Â  Â  rSum += img.data[i];
Â  Â  Â  Â  Â  Â  gSum += img.data[i+1];
Â  Â  Â  Â  Â  Â  bSum += img.data[i+2];
Â  Â  Â  Â  Â  Â  count++;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }catch(e){
Â  Â  Â  Â  Â  console.warn('getImageData error', e);
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  if(count>0){
Â  Â  Â  Â  Â  const r = Math.round(rSum/count);
Â  Â  Â  Â  Â  const g = Math.round(gSum/count);
Â  Â  Â  Â  Â  const b = Math.round(bSum/count);
Â  Â  Â  Â  Â  const colorName = namaWarnaFromRGB(r,g,b);
Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  // Update Info Warna
Â  Â  Â  Â  Â  infoColor.innerText = colorName + ` (rgb: ${r},${g},${b})`;
Â  Â  Â  Â  Â  infoColorSwatch.style.backgroundColor = `rgb(${r},${g},${b})`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  infoColor.innerText = 'Gagal Ambil Warna';
Â  Â  Â  Â  Â  infoColorSwatch.style.backgroundColor = '#333';
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 2. UPDATE OBJEK TEXT ---
Â  Â  Â  Â  infoClass.innerText = primary.class + ' (' + (primary.score*100).toFixed(0) + '%)';

Â  Â  Â  Â  // --- 3. ESTIMATE DISTANCE ---
Â  Â  Â  Â  const knownWidth = getKnownWidthCm(primary.class); // Gunakan lebar asumsi dinamis
Â  Â  Â  Â  const distCm = estimateDistanceCm(primary.bbox[2], knownWidth); 
Â  Â  Â  Â  infoDist.innerText = distCm + ' cm (asumsi lebar ' + knownWidth + 'cm)';

Â  Â  Â  } else {
Â  Â  Â  Â  // Reset info jika tidak ada objek terdeteksi
Â  Â  Â  Â  infoClass.innerText = '-';
Â  Â  Â  Â  infoColor.innerText = '-';
Â  Â  Â  Â  infoColorSwatch.style.backgroundColor = '#333';
Â  Â  Â  Â  infoDist.innerText = '-';
Â  Â  Â  }

Â  Â  }catch(err){
Â  Â  Â  console.error('Detect error', err);
Â  Â  }

Â  Â  rafId = requestAnimationFrame(frame);
Â  }

Â  frame();
}

/* ====== UI Wiring ====== */
btnStart.addEventListener('click', startCamera);
btnStop.addEventListener('click', stopCamera);
btnSnapshot.addEventListener('click', ()=>{
Â  // snapshot overlay + video
Â  const tmp = document.createElement('canvas');
Â  tmp.width = overlay.width; tmp.height = overlay.height;
Â  const tctx = tmp.getContext('2d');
Â  // draw current video then overlay
Â  tctx.drawImage(video,0,0,tmp.width,tmp.height);
Â  tctx.drawImage(overlay,0,0);
Â  const a = document.createElement('a');
Â  a.href = tmp.toDataURL('image/png');
Â  a.download = 'snapshot-' + new Date().toISOString().replace(/[:.]/g,'-') + '.png';
Â  a.click();
});

// threshold UI
thresholdEl.addEventListener('input', ()=> thVal.innerText = thresholdEl.value);

/* ====== Auto-load model early (so user can start faster) ====== */
(async ()=>{
Â  // attempt to set fast backend (webgl) if available
Â  try{ await tf.setBackend('webgl'); } catch(e){ /* ignore */ }
Â  modelStatus.innerText = 'Memuat model (Webgl)...';
Â  try{
Â  Â  model = await cocoSsd.load();
Â  Â  modelStatus.innerText = 'Model siap âœ”';
Â  Â  console.log('Model siap.');
Â  }catch(e){
Â  Â  console.error('Gagal memuat model', e);
Â  Â  modelStatus.innerText = 'Gagal memuat (lihat console)';
Â  }
})();
</script>
</body>
</html>
