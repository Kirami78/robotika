<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>TFJS Object Detection - FIX CAMERA</title>

  <!-- Load TensorFlow -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.2.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

  <style>
    body {
      background: black;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: white;
      font-family: Arial;
    }
    video, canvas {
      width: 90vw;
      max-width: 600px;
      margin-top: 20px;
      background: #222;
    }
  </style>
</head>

<body>

<h2>Camera Test + Object Detection (FIXED)</h2>

<video id="video" autoplay playsinline muted></video>
<canvas id="canvas"></canvas>

<script>
let model;

async function initCamera() {
  const video = document.getElementById("video");

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        width: { ideal: 1280 },
        height: { ideal: 720 },
        facingMode: "environment"
      },
      audio: false
    });

    video.srcObject = stream;

    return new Promise(resolve => {
      video.onloadedmetadata = () => {
        console.log("Camera ready:", video.videoWidth, "x", video.videoHeight);
        video.play();
        resolve(video);
      };
    });

  } catch (err) {
    console.error("Camera Error:", err);
    alert("Tidak bisa membuka kamera.\nIjinkan kamera di browser kamu.");
  }
}

async function start() {
  const video = await initCamera();

  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  model = await cocoSsd.load();
  console.log("Model loaded");

  async function detect() {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const predictions = await model.detect(video);

    predictions.forEach(pred => {
      const [x, y, w, h] = pred.bbox;

      ctx.strokeStyle = "cyan";
      ctx.lineWidth = 3;
      ctx.strokeRect(x, y, w, h);

      ctx.fillStyle = "cyan";
      ctx.font = "16px Arial";
      ctx.fillText(pred.class + " " + (pred.score * 100).toFixed(1) + "%", x, y - 5);
    });

    requestAnimationFrame(detect);
  }

  detect();
}

start();
</script>

</body>
</html>
