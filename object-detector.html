<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Deteksi Objek + Warna + Jarak</title>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

<style>
    body {
        margin: 0;
        background: #101010;
        color: white;
        font-family: Arial;
        text-align: center;
    }
    #container {
        margin-top: 20px;
        position: relative;
        display: inline-block;
    }
    video, canvas {
        border-radius: 10px;
        box-shadow: 0 0 20px #00ffcc55;
    }
</style>
</head>

<body>
<h1>ðŸ”¥ Deteksi Objek â€¢ Warna â€¢ Jarak</h1>

<div id="container">
    <video id="video" width="640" height="480" autoplay playsinline muted></video>
    <canvas id="canvas" width="640" height="480" willReadFrequently="true"
        style="position:absolute; top:0; left:0;"></canvas>
</div>

<script>
let model;
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d", { willReadFrequently: true });

// -------------------------------------------------------------
// ðŸ”µ Start Kamera
// -------------------------------------------------------------
async function startCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" }
    });
    video.srcObject = stream;
    await video.play();
}

// -------------------------------------------------------------
// ðŸ”µ Mengambil warna rata-rata dalam bounding box
// -------------------------------------------------------------
function getColorName(r, g, b) {
    if (r > 200 && g < 80 && b < 80) return "Merah";
    if (r > 200 && g > 120 && b < 80) return "Oranye";
    if (r > 200 && g > 200 && b < 100) return "Kuning";
    if (g > 180 && r < 100 && b < 100) return "Hijau";
    if (b > 180 && r < 100 && g < 100) return "Biru";
    if (r > 150 && g > 100 && b > 150) return "Ungu";
    if (r > 200 && g > 200 && b > 200) return "Putih";
    if (r < 80 && g < 80 && b < 80) return "Hitam";
    return "Tidak diketahui";
}

// -------------------------------------------------------------
// ðŸ”µ Estimasi jarak (kasar)
// -------------------------------------------------------------
function estimasiJarak(boxHeightPx) {
    const tinggiAsli = 20; // cm (asumsi tinggi objek)
    const focalLength = 500; 
    return Math.round((tinggiAsli * focalLength) / boxHeightPx);
}

// -------------------------------------------------------------
// ðŸ”µ Loop Deteksi
// -------------------------------------------------------------
async function detect() {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const predictions = await model.detect(canvas);

    predictions.forEach(pred => {
        const [x, y, w, h] = pred.bbox;

        // Warna rata-rata
        const imgData = ctx.getImageData(x, y, w, h);
        let r = 0, g = 0, b = 0;
        const pixels = imgData.data;
        for (let i = 0; i < pixels.length; i += 4) {
            r += pixels[i];
            g += pixels[i + 1];
            b += pixels[i + 2];
        }
        const total = pixels.length / 4;
        r = r / total; g = g / total; b = b / total;

        const namaWarna = getColorName(r, g, b);
        const jarak = estimasiJarak(h);

        // Gambar bounding box
        ctx.strokeStyle = "#00FFC8";
        ctx.lineWidth = 3;
        ctx.strokeRect(x, y, w, h);

        // Label
        ctx.fillStyle = "rgba(0,0,0,0.7)";
        ctx.fillRect(x, y - 40, 200, 40);

        ctx.fillStyle = "#00FFC8";
        ctx.font = "16px Arial";
        ctx.fillText(
            `${pred.class} | Warna: ${namaWarna} | Jarak: ${jarak} cm`,
            x + 5, y - 15
        );
    });

    requestAnimationFrame(detect);
}

// -------------------------------------------------------------
// ðŸ”µ Start semuanya
// -------------------------------------------------------------
async function start() {
    await startCamera();
    model = await cocoSsd.load();
    console.log("Model siap!");
    detect();
}

start();
</script>
</body>
</html>
